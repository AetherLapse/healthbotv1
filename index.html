<script>
  // Fetch the Ngrok URL dynamically
  async function getNgrokUrl() {
    try {
      const response = await fetch('http://localhost:8000/get_ngrok_url');
      const data = await response.json();
      return data.ngrok_url; // Return the ngrok public URL
    } catch (error) {
      console.error('Failed to fetch Ngrok URL:', error);
      return ''; // Return empty string in case of an error
    }
  }

  const chatbox = document.getElementById('chatbox');
  let state = {}; // Store session state for the chatbot

  // Function to append messages to the chatbox
  function appendMessage(text, sender) {
    const message = document.createElement('div');
    message.className = `${sender} message`;
    message.innerText = text;
    chatbox.appendChild(message);
    chatbox.scrollTop = chatbox.scrollHeight; // Auto-scroll to the bottom
  }

  // Function to send the user message to the backend
  async function sendMessage() {
    const input = document.getElementById('userInput');
    const userMessage = input.value.trim();
    if (!userMessage) return; // Don't send empty messages

    // Display the user message
    appendMessage(userMessage, 'user');
    input.value = ''; // Clear the input field

    const ngrokUrl = await getNgrokUrl(); // Get the dynamic ngrok URL

    if (!ngrokUrl) {
      appendMessage('Error: Could not fetch the Ngrok URL.', 'bot');
      return;
    }

    // Send the message to the backend
    try {
      const response = await fetch(ngrokUrl + '/chat/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: userMessage, state: state }),
      });

      const data = await response.json();
      appendMessage(data.response, 'bot'); // Display bot response
      state = data.state; // Update the session state
    } catch (error) {
      appendMessage('Oops! Something went wrong. Please try again.', 'bot');
      console.error('Error communicating with the backend:', error);
    }
  }
</script>
